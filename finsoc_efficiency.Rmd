---
title: "Efficiency of Microfinance Institutions in Africa"
author: "John Karuitha and Kalu Ojah"
date: "`r format(Sys.Date(), '%A, %B %d, %Y')`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(dtplyr)
library(plm)
library(pglm)
library(gmnl)
library(ggthemes)
library(GGally)
library(skimr)
library(prettydoc)
library(gridExtra)
library(psych)
library(stargazer)
library(corrplot)
library(excelR)
library(bookdown)
library(rmarkdown)
library(gghalves)
library(ggalt)  
library(ggrepel)  # for annotations
library(viridis)  # for nice colors
library(broom)  # for cleaning up models
library(treemapify)  # for making area graphs
library(wesanderson)  # for nice colors
library(janitor)
library(readxl)
library(magrittr)
library(mice)
library(patchwork)
library(Rchoice)
library(gplots)
library(margins)
library(lme4)
library(kableExtra)
library(caret)
library(nnet)
library(pROC)
library(ConfusionTableR)
library(gtable)
library(gmodels)

#########################################
options(digits = 4)
options(knitr.kable.NA = "-")
theme_set(ggthemes::theme_clean())
#########################################
```



```{r}
## legal traditions 
### Common law countries in Africa
common <- tibble(country = c("Botswana", "Gambia, The", "Ghana", "Kenya", "Lesotho", "Liberia", "Malawi", "Namibia", "Nigeria", "Sierra Leone", "South Africa", "South Sudan", "Sudan", "Eswatini", "Tanzania", "Uganda", "Zambia", "Zimbabwe"), trad = c(rep("common", 18)))

### Civil law countries in Africa
civil <- tibble(country = c("Algeria", "Benin", "Burkina Faso", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo, Rep.", "Cote d'Ivoire", "Gabon", "Guinea", "Madagascar", "Mali", "Mauritania", "Morocco", "Niger", "Senegal", "Togo", "Tunisia"), trad = c(rep("civil", 19)))

### Other legal traditions in Africa
others <- tibble(country = c("Equatorial Guinea", "Angola", "Burundi", "Cape Verde", "Congo, Dem. Rep.", "Egypt, Arab Republic of", "Ethiopia", "Eritrea", "Guinea-Bissau", "Mozambique", "Rwanda"), trad = c(rep("others", 11)))

###Putting them all together
legal <- rbind(common, civil, others)
```


```{r}
# Bond market data - private and public bond market capitalization to GDP
bonds <- read_excel("bonds_oluoch.xlsx") %>% 
  
  janitor::clean_names()

```

```{r}
# Add the financial development index to the dataset
## Countries not part of Africa
mideast <- c("Bahrain", "Iran, Islamic Rep.", "Iraq", "Israel", "Jordan", "Kuwait", "Lebanon", "Malta", "Oman", "Qatar", "Saudi Arabia", "Syrian Arab Republic", "United Arab Emirates", "West Bank and Gaza", "Yemen, Rep.")

## Load the financial structure data
finstr <- read_excel("FinancialStructureDatabase20191018.xlsx", sheet = 4) %>% 
  
  ## Select desired variables
  select(country, region, year, pcrdbgdp, stmktcap, stvaltraded, stturnover, listco_pc) %>% 
  
  ### Filter out regions not in Africa or middle east
  filter(region == "Sub-Saharan Africa" | region == "Middle East & North Africa") %>% 
  ### Filter out countries in middle east and select year 1999 onwards
  filter(!country %in% mideast, year >= 1999) %>% 
  
## Replace NAs
          group_by(country) %>% 
  
          mutate(pcrdbgdp = replace_na(pcrdbgdp, median(pcrdbgdp, na.rm = TRUE)),
                 
                 pcrdbgdp = replace_na(pcrdbgdp, 0),
                 
                 stmktcap = replace_na(stmktcap, median(stmktcap, na.rm = TRUE)),
                 
                 stmktcap = replace_na(stmktcap, 0)) %>% ungroup() %>% 
  
## Join with the bonds data
  left_join(bonds, by = c("country", "year")) %>% 
  
## rename bonds columns 
  rename(prbonds = outstanding_t_bonds_percent_gdp, 
         
         pubonds = outstanding_c_bonds_percent_gdp) %>% 
  
  ## Replace NAs in public bond and private bond markets 
  mutate(pubonds = replace_na(pubonds, 0), 
         
         prbonds = replace_na(prbonds, 0)) %>% 
  
         ## Rename Ivory Coast
         mutate(country = if_else(country == "Côte d'Ivoire", "Cote d'Ivoire", 
                                  
                                  country))

## View missing data points
#mice::md.pattern(finstr)

#finstr %>% select(pcrdbgdp, stmktcap) %>% cor(.) %>% 
  
  #corrplot(method = "number", type = "lower")
```

```{r}
## Read in the dataset 
my_data <- read_csv("amelia.csv") %>% 

## Region
mutate(region = if_else(region == "Middle East and North Africa", 
                        
                        "North_Africa", region)) %>% 

# Clean the names 
janitor::clean_names() %>% 
  
# Set up factor variables 
## legal status 
mutate(currentlegalstatus = factor(currentlegalstatus, 
                           levels = c("NGO", "Bank", "NBFI", 
                            "Credit Union/ Cooperative", 
                            "Rural Bank")), 
      ## Age
      age = factor(age, levels = c("New", "Young", "Mature")),
       
      ## Region 
      region = factor(region, levels = c("North_Africa", "Africa"))) %>% 
  
      ## Add the financial structure data     
      left_join(finstr, by = c("country", "year")) %>% 
  
      ## Add a binary variable for the legal dummy- NGO vs Others
      mutate(currentlegaldummy = case_when(currentlegalstatus == "NGO" ~ "NGO",
                                           
                                           TRUE ~ "others"),
      
        currentlegaldummy = factor(currentlegaldummy, levels = c("NGO", "others")),
        
        legal_tradition = factor(legal_tradition, 
                                 
                                 levels = c("Common", "Civil", "Other"))) %>% 
  ## Select required variables 
  select(mfiid, mfiname, year, country, currentlegaldummy, currentlegalstatus, 
         
         percent_of_female_borrowers, operational_self_sufficiency,
         
         age, legal_tradition, region.x, asset_structure, 
         
         assets, kkm, education, pcrdbgdp, stmktcap, prbonds, 
         
         gdp_growth_annual, donations, donations_assets_ratio, 
         
         profit_margin, debt_to_equity_ratio, capital_asset_ratio, 
         
         deposits_to_total_assets, liabilities_and_equity, 
         
         operating_expense_assets, average_loan_balance_per_borrower,
         
         gross_loan_portfolio_to_total_assets, net_fixed_assets) %>% 
  
          ## Rename region
         rename(region = region.x) %>% 
  
  group_by(country) %>% 
  
  mutate(kkm = replace_na(kkm, median(kkm, na.rm = TRUE)),
         education = replace_na(education, median(education, na.rm = TRUE)),
         prbonds = replace_na(prbonds, median(prbonds, na.rm = TRUE)),
         pcrdbgdp = replace_na(pcrdbgdp, median(pcrdbgdp, na.rm = TRUE)),
         stmktcap = replace_na(stmktcap, median(stmktcap, na.rm = TRUE))) %>% 
  
  ungroup() %>% 
  
  group_by(mfiid) %>% 
  
  mutate(asset_structure = replace_na(asset_structure, median(asset_structure, na.rm = TRUE)), 
         
         percent_of_female_borrowers = replace_na(percent_of_female_borrowers, 
                                                  
                                                  median(percent_of_female_borrowers, na.rm = TRUE)),
         
         operational_self_sufficiency = replace_na(operational_self_sufficiency, 
                                                   
                                                   median(operational_self_sufficiency, na.rm = TRUE)),
         
         assets = replace_na(assets, median(assets, na.rm = TRUE)),
         
         donations = replace_na(donations, median(donations, na.rm = TRUE)),
         
         donations_assets_ratio = replace_na(donations_assets_ratio, 
                                             
                                  median(donations_assets_ratio, na.rm = TRUE)),
         
         profit_margin = replace_na(profit_margin, median(profit_margin, na.rm = TRUE)), 
         
         capital_asset_ratio = replace_na(capital_asset_ratio, median(capital_asset_ratio, na.rm = TRUE)), 
         
         debt_to_equity_ratio = replace_na(debt_to_equity_ratio, median(debt_to_equity_ratio, na.rm = TRUE)), 
         
         deposits_to_total_assets = replace_na(deposits_to_total_assets, 
                                               
                                               median(deposits_to_total_assets, na.rm = TRUE)),
         
         liabilities_and_equity = replace_na(liabilities_and_equity, 
                                             
                                             median(liabilities_and_equity, na.rm = TRUE)), 
         
         operating_expense_assets = replace_na(operating_expense_assets, 
                                               
                                               median(operating_expense_assets, na.rm = TRUE)), 
         
         average_loan_balance_per_borrower = replace_na(average_loan_balance_per_borrower, 
                                                        
                                                        median(average_loan_balance_per_borrower, na.rm = TRUE)), 
         
         gross_loan_portfolio_to_total_assets = replace_na(gross_loan_portfolio_to_total_assets, 
                                                        
                                                        median(gross_loan_portfolio_to_total_assets, na.rm = TRUE)),
         
         net_fixed_assets = replace_na(net_fixed_assets, median(net_fixed_assets, na.rm = TRUE))) %>% 
  
  ungroup() %>% 
  
  group_by(region) %>% 
  
  mutate(education = replace_na(education, median(education, na.rm = TRUE)),
         
         kkm = replace_na(kkm, median(kkm, na.rm = TRUE)),
         
         gdp_growth_annual = replace_na(gdp_growth_annual, 
                                        
         median(gdp_growth_annual, na.rm = TRUE))) %>% 
  
  ungroup() %>% 
  
  group_by(currentlegalstatus) %>% 
  
  mutate(assets = replace_na(assets, median(assets, na.rm = TRUE)), 
         
         percent_of_female_borrowers = replace_na(percent_of_female_borrowers, 
                                                  
                        median(percent_of_female_borrowers, na.rm = TRUE)),
         
         operational_self_sufficiency = replace_na(operational_self_sufficiency, 
                                                   
                        median(operational_self_sufficiency, na.rm = TRUE)),
         
         donations = replace_na(donations, median(donations, na.rm = TRUE)),
         
         donations_assets_ratio = replace_na(donations_assets_ratio, 
                                             
                                  median(donations_assets_ratio, na.rm = TRUE)), 
         
         profit_margin = replace_na(profit_margin, median(profit_margin, na.rm = TRUE)), 
         
         capital_asset_ratio = replace_na(capital_asset_ratio, median(capital_asset_ratio, na.rm = TRUE)), 
         
         debt_to_equity_ratio = replace_na(debt_to_equity_ratio, median(debt_to_equity_ratio, na.rm = TRUE)), 
         
         deposits_to_total_assets = replace_na(deposits_to_total_assets, median(deposits_to_total_assets, 
                                                                                
                                                                                na.rm = TRUE)), 
         
         liabilities_and_equity = replace_na(liabilities_and_equity, 
                                             
                                             median(liabilities_and_equity, na.rm = TRUE)), 
         
         operating_expense_assets = replace_na(operating_expense_assets, 
                                               
                                               median(operating_expense_assets, na.rm = TRUE)), 
         
         average_loan_balance_per_borrower = replace_na(average_loan_balance_per_borrower, 
                                                        
                                                        median(average_loan_balance_per_borrower, na.rm = TRUE)), 
         
         gross_loan_portfolio_to_total_assets = replace_na(gross_loan_portfolio_to_total_assets, 
                                                        
                                                        median(gross_loan_portfolio_to_total_assets, na.rm = TRUE)),
         
         net_fixed_assets = replace_na(net_fixed_assets, median(net_fixed_assets, na.rm = TRUE))) %>% 
  
  ungroup() %>% 
  
  mutate(dummy = if_else(currentlegaldummy == "NGO", 0, 1)) %>% 
  
  mutate(assets = log(assets + 1),
         
         pcrdbgdp = log(pcrdbgdp + 1),
         
         stmktcap = log(stmktcap + 1),
         
         prbonds = log(prbonds + 1)) %>% 
  
  select(-asset_structure) %>% 
  
  add_count(mfiid, name = "count") %>% 
  
  mutate(currentlegalstatus = fct_recode(currentlegalstatus, Coop = "Credit Union/ Cooperative")) %>% 
  
  mutate(finsoc = case_when(operational_self_sufficiency >= 1 & percent_of_female_borrowers > 0.5 ~ "SS",
                            
                            operational_self_sufficiency > 1 & percent_of_female_borrowers < 0.5 ~ "SF", 
                            
                            operational_self_sufficiency < 1 & percent_of_female_borrowers >= 0.5 ~ "FS",
                            
                            TRUE ~ "FF")) %>% 
  
mutate(finsoc = factor(finsoc, levels = c("FF", "SF", "FS", "SS"))) %>% 
  
## replace negative donations with zero
mutate(donations = case_when(donations <= 0 ~ 1,
                             TRUE ~ donations + 1)) %>% 
  
mutate(stmktcap = if_else(stmktcap == 0, 1, stmktcap + 1)) %>% 
  
mutate(donations_assets_ratio = case_when(donations_assets_ratio <= 0 ~ 1,
                             TRUE ~ donations_assets_ratio + 1)) %>% 
  
mutate(profit_margin = case_when(profit_margin < -50 ~ 51,
                                 TRUE ~ profit_margin + 51))

## Write a csv for the data
my_data %>% write.csv(., "data.csv")

## Visualize missing data
#md.pattern(data)
## Amelia::missmap(data)

## MFIs with three (3) or more years of data
data3 <- my_data %>% 
  
  group_by(mfiid) %>% 
  
  filter(n() > 3)
  
data3 %>% write.csv(., "data3.csv")

## MFIs with three (3) or more years of data
data5 <- my_data %>% 
  
  group_by(mfiid) %>% 
  
  filter(n() > 5)  
  
data5 %>% write.csv(., "data5.csv")
```


```{r}
median_n <- function(x){median(x, na.rm = TRUE)}
```

```{r}
theme_niwot <- function(){
  theme_bw() +
    theme(axis.text = element_text(size = 7), 
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 8),
          axis.line.x = element_line(color="black"), 
          axis.line.y = element_line(color="black"),
          panel.border = element_blank(),
          panel.grid.major.x = element_blank(),                                          
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),  
          plot.margin = unit(c(1, 1, 1, 1), units = , "cm"),
          plot.title = element_text(size = 10, vjust = 1, hjust = 0),
          legend.text = element_text(size = 8),          
          legend.title = element_blank(),                              
          legend.position = c(0.95, 0.15), 
          legend.key = element_blank(),
          legend.background = element_rect(color = "black", 
                                           fill = "transparent", 
                                           size = 2, linetype = "blank"))
}
```



```{r}
###########################################
#' ggplot Flat Violin
#' @export
#' @details Copy-pasted from https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R
#' somewhat hackish solution to:
#' https://twitter.com/EamonCaddigan/status/646759751242620928
#' based mostly on copy/pasting from ggplot2 geom_violin source:
#' https://github.com/hadley/ggplot2/blob/master/R/geom-violin.r
#' @examples:
#' ggplot(diamonds, aes(cut, carat)) +
#'   geom_flat_violin() +
#'   coord_flip()
#' @import ggplot2
geom_flat_violin <- function(mapping = NULL, data = NULL, stat = "ydensity",
                             position = "dodge", trim = TRUE, scale = "area",
                             show.legend = NA, inherit.aes = TRUE, ...) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomFlatViolin,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      trim = trim,
      scale = scale,
      ...
    )
  )
}

#' @rdname ggplot2-ggproto
#' @format NULL
#' @usage NULL
#' @export
GeomFlatViolin <-
  ggproto("GeomFlatViolin", Geom,
          setup_data = function(data, params) {
            data$width <- data$width %||%
              params$width %||% (resolution(data$x, FALSE) * 0.9)

            # ymin, ymax, xmin, and xmax define the bounding rectangle for each group
            data %>%
              group_by(group) %>%
              mutate(ymin = min(y),
                     ymax = max(y),
                     xmin = x,
                     xmax = x + width / 2)

          },

          draw_group = function(data, panel_scales, coord) {
            # Find the points for the line to go all the way around
            data <- transform(data, xminv = x,
                              xmaxv = x + violinwidth * (xmax - x))

            # Make sure it's sorted properly to draw the outline
            newdata <- rbind(plyr::arrange(transform(data, x = xminv), y),
                             plyr::arrange(transform(data, x = xmaxv), -y))

            # Close the polygon: set first and last point the same
            # Needed for coord_polar and such
            newdata <- rbind(newdata, newdata[1,])

            ggplot2:::ggname("geom_flat_violin", GeomPolygon$draw_panel(newdata, panel_scales, coord))
          },

          draw_key = draw_key_polygon,

          default_aes = aes(weight = 1, colour = "grey20", fill = "white", size = 0.5,
                            alpha = NA, linetype = "solid"),

          required_aes = c("x", "y")
  )


"%||%" <- function(a, b) {
  if (!is.null(a)) a else b
}
###########################################################
```



```{r}
# plotting function
plotter <- function(data, x , y, z, xlabel, ylabel, title){
  
  library(tidyverse)
  library(ggthemes)
  library(gghalves)
  library(ggalt)  
  library(ggrepel)  # for annotations
  library(viridis)  # for nice colors
  library(broom)  # for cleaning up models
  library(treemapify)  # for making area graphs
  library(wesanderson)  # for nice colors
  
  ggplot(data = data, mapping = aes(x = reorder({{x}}, {{y}}, median_n), 
  y = {{y}}, fill = {{z}})) + 
  geom_boxplot(width = 0.2, outlier.shape = NA, alpha = 0.8, aes(fill = {{z}})) +
  geom_half_violin(position = position_nudge(x = 0.2, y = 0), alpha = 0.8) + 
    geom_point(position = position_jitter(width = 0.15), size = 1, alpha = 0.1) + 
    scale_y_log10() + labs(y = ylabel, x = xlabel, 
  title = title) + 
  theme_niwot() + 
  theme(legend.position = "none") + 
  stat_summary(fun = mean, geom = "point", 
                size = 1, color = "red")}

##################################################
second_plotter <- function(data, x , y, z, xlabel, ylabel, title){

library(ggalt)  
library(ggrepel)  # for annotations
library(viridis)  # for nice colours
library(broom)  # for cleaning up models
# devtools::install_github("wilkox/treemapify")
library(treemapify)  # for making area graphs
library(wesanderson)  # for nice colours

  ggplot(data = data, 
           mapping = aes(x = reorder({{x}}, {{y}}, median_n), y = {{y}}, fill = {{z}})) +
    
    # The half violins
    geom_flat_violin(position = position_nudge(x = 0.2, y = 0), alpha = 0.8) +
    
    # The points
    geom_point(aes(y = {{y}}, color = {{x}}), 
    
    position = position_jitter(width = 0.15), size = 1, alpha = 0.1) +
    
    # The boxplots
    geom_boxplot(width = 0.2, outlier.shape = NA, alpha = 0.8) +
    
    # \n adds a new line which creates some space between the axis and axis title
    labs(x = xlabel, y = ylabel, title = title) +
    
    # Removing legends
    guides(fill = FALSE, color = FALSE) +
    
    # Setting the limits of the y axis
    #scale_y_continuous(limits = c(0, 1.2)) +
    
    # Picking nicer colours
    scale_fill_manual(values = c("#5A4A6F", "#E47250",  "#EBB261", "#9D5A6C", "#FFFF80FF")) +
    
    scale_colour_manual(values = c("#5A4A6F", "#E47250",  "#EBB261", "#9D5A6C", "#FFFF80FF")) +
    
    theme_niwot() + scale_y_log10()
}
```


```{r}
hausmann_test <- function(data, depvar){
  
  
  library(broom)
  library(pcse)
  library(car)
  library(zoo)
  library(lmtest)
  library(broom)

  ################################################# 
  fixed <- plm(depvar ~ age + currentlegalstatus + 
                      
                      legal_tradition + 
                      
                      assets + kkm + pcrdbgdp + 
                      
                      log(stmktcap) + log(profit_margin) + 
                      
                      log(donations_assets_ratio) + 
                      
                      gdp_growth_annual + factor(year), 
               
                      data = my_data, 
               
                      effect = "individual", 
               
                      model = "within", 
               
                 index = c("mfiid", "year")) 
  
#################################################
  random <- plm(depvar ~ age + currentlegalstatus + 
                      
                      legal_tradition + 
                      
                      assets + kkm + pcrdbgdp + 
                      
                      log(stmktcap) + log(profit_margin) + 
                      
                      log(donations_assets_ratio) + 
                      
                      gdp_growth_annual + factor(year), 
                
          data = my_data, 
          
          effect = "individual", 
          
          model = "random",
          
          index = c("mfiid", "year"))
 
  broom::tidy(phtest(fixed, random))
}
```



```{r}
## Regression function - fixed, random and pooling ---- 
modelling <- function(depvar,
                      effect = c("individual", "twoways", "time", "nested"),
                      model = c("within", "random", "ht", "between", "pooling", "fd"),
                      inst.method = c("bvk", "baltagi", "am", "bms"),
                      random.method = c("swar", "amemiya", "walhus", "nerlove"),
                      digits = 4, index = c("mfiid", "year")){
  
  ## Load libraries
  library(plm)
  library(broom)
  library(pcse)
  library(car)
  library(zoo)
  library(lmtest)
  library(broom)
  library(stargazer)
  
  ## match arguments
  effect <- match.arg(effect)
  model <- match.arg(model)
  inst.method <- match.arg(inst.method)
  random.method <- match.arg(random.method)

  
  ## Run the Model
  plm(depvar ~ age + currentlegalstatus + 
                      
                      legal_tradition + 
                      
                      assets + kkm + pcrdbgdp + 
                      
                      log(stmktcap) + log(profit_margin) + 
                      
                      log(donations_assets_ratio) + 
                      
                      gdp_growth_annual + factor(year), 
                      
                      data = my_data,
                    
                    effect = effect,
                    
                    model = model, 
                    
                    inst.method = inst.method, 
                    
                    index = index, 
                    
                    digits = digits)
  
  ## Output results
       
       ## Correct standard errors for heteroscedasticity 
       ## And cross-sectional dependence
       
       #coeftest(unadjusted, vcov. = function(x) {
         #vcovBK(x, method = "arellano", type="HC1", cluster = "group")
       #})
}

```


```{r}
## Regression function - fixed, random and pooling ---- 
modelling3 <- function(depvar,
                      effect = c("individual", "twoways", "time", "nested"),
                      model = c("within", "random", "ht", "between", "pooling", "fd"),
                      inst.method = c("bvk", "baltagi", "am", "bms"),
                      random.method = c("swar", "amemiya", "walhus", "nerlove"),
                      digits = 4, index = c("mfiid", "year")){
  
  ## Load libraries
  library(plm)
  library(broom)
  library(pcse)
  library(car)
  library(zoo)
  library(lmtest)
  library(broom)
  library(stargazer)
  
  ## match arguments
  effect <- match.arg(effect)
  model <- match.arg(model)
  inst.method <- match.arg(inst.method)
  random.method <- match.arg(random.method)

  
  ## Run the Model
  plm(depvar ~ age + currentlegalstatus + 
                      
                      legal_tradition + 
                      
                      assets + kkm + pcrdbgdp + 
                      
                      log(stmktcap) + log(profit_margin) + 
                      
                      log(donations_assets_ratio) + 
                      
                      gdp_growth_annual + factor(year), 
                      
                      data = data3,
                    
                    effect = effect,
                    
                    model = model, 
                    
                    inst.method = inst.method, 
                    
                    index = index, 
                    
                    digits = digits)
  
  ## Output results
       
       ## Correct standard errors for heteroscedasticity 
       ## And cross-sectional dependence
       
       #coeftest(unadjusted, vcov. = function(x) {
         #vcovBK(x, method = "arellano", type="HC1", cluster = "group")
       #})
}

```


```{r}
## Regression function - fixed, random and pooling ---- 
modelling5 <- function(depvar,
                      effect = c("individual", "twoways", "time", "nested"),
                      model = c("within", "random", "ht", "between", "pooling", "fd"),
                      inst.method = c("bvk", "baltagi", "am", "bms"),
                      random.method = c("swar", "amemiya", "walhus", "nerlove"),
                      digits = 4, index = c("mfiid", "year")){
  
  ## Load libraries
  library(plm)
  library(broom)
  library(pcse)
  library(car)
  library(zoo)
  library(lmtest)
  library(broom)
  library(stargazer)
  
  ## match arguments
  effect <- match.arg(effect)
  model <- match.arg(model)
  inst.method <- match.arg(inst.method)
  random.method <- match.arg(random.method)

  
  ## Run the Model
  plm(depvar ~ age + currentlegalstatus + 
                      
                      legal_tradition + 
                      
                      assets + kkm + pcrdbgdp + 
                      
                      log(stmktcap) + log(profit_margin) + 
                      
                      log(donations_assets_ratio) + 
                      
                      gdp_growth_annual + factor(year), 
                      
                      data = data5,
                    
                    effect = effect,
                    
                    model = model, 
                    
                    inst.method = inst.method, 
                    
                    index = index, 
                    
                    digits = digits)
  
  ## Output results
       
       ## Correct standard errors for heteroscedasticity 
       ## And cross-sectional dependence
       
       #coeftest(unadjusted, vcov. = function(x) {
         #vcovBK(x, method = "arellano", type="HC1", cluster = "group")
       #})
}

```


```{r}
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.10, .90), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}


data_wins_capital_structures <- my_data %>% 
  
  select(assets, kkm, pcrdbgdp, 
                      
                      stmktcap, profit_margin,
                      
                      donations_assets_ratio,
                      
                      gdp_growth_annual, 
         
         capital_asset_ratio, 
         
         deposits_to_total_assets)


data_wins <- sapply(data_wins_capital_structures, remove_outliers) %>% 
  
  cbind(my_data[,c("mfiid", "year", "age", "currentlegalstatus", 
                      
                      "legal_tradition")]) %>% 
  
  na.omit() %>% 
  
  relocate(mfiid:legal_tradition)
```



```{r}
## Regression function - fixed, random and pooling ---- 
modelling_wins <- function(depvar,
                      effect = c("individual", "twoways", "time", "nested"),
                      model = c("within", "random", "ht", "between", "pooling", "fd"),
                      inst.method = c("bvk", "baltagi", "am", "bms"),
                      random.method = c("swar", "amemiya", "walhus", "nerlove"),
                      digits = 4, index = c("mfiid", "year")){
  
  ## Load libraries
  library(plm)
  library(broom)
  library(pcse)
  library(car)
  library(zoo)
  library(lmtest)
  library(broom)
  library(stargazer)
  
  ## match arguments
  effect <- match.arg(effect)
  model <- match.arg(model)
  inst.method <- match.arg(inst.method)
  random.method <- match.arg(random.method)

  
  ## Run the Model
  plm(depvar ~ age + currentlegalstatus + 
                      
                      legal_tradition + 
                      
                      assets + kkm + pcrdbgdp + 
                      
                      log(stmktcap) + log(profit_margin) + 
                      
                      log(donations_assets_ratio) + 
                      
                      gdp_growth_annual + factor(year), 
                      
                      data = data_wins,
                    
                    effect = effect,
                    
                    model = model, 
                    
                    inst.method = inst.method, 
                    
                    index = index, 
                    
                    digits = digits)
  
  ## Output results
       
       ## Correct standard errors for heteroscedasticity 
       ## And cross-sectional dependence
       
       #coeftest(unadjusted, vcov. = function(x) {
         #vcovBK(x, method = "arellano", type="HC1", cluster = "group")
       #})
}

```


## **Abstract**

>We examine the levels as well as the drivers of financial efficiency, social efficiency, and joint socio-economic efficiency of microfinance institutions (MFIs) in Africa, using data on 705 MFIs across the continent, for 2000-2019. Broadly, our results show a decline in social performance over time but no discernible trend in financial performance; and that the legal status of an MFI particularly drives its social and socio-financial performance. Specifically, operating efficiency, capital adequacy, asset structure, and education are significant drivers of our target efficiencies. More specifically, operating costs relates negatively to financial efficiency, but relate positively to social efficiency and socio-financial efficiency. Capital andequacy relates positively to financial, social and socio-financial efficiencies, whereas asset structure relates negatively to these three efficiency variables. Education relates negatively to financial efficiency but negativey to social and socio-financial efficiencies. Taken together, these results suggest that while access to commercial capital enhances overall efficiency, the quest for profitability (and financial efficiency by extension) appears to diminish social efficiency. Importantly, our analysis shows a trade-off between financial efficiency on the one hand and social efficiency and social-financial efficiency on the other. Our results remain robust after exclusing outliers in the analysis ^[1. Graduate School of Business Administration, University of the Witwatersrand, 2nd St Davids Place, Johannesburg, South Africa, 2050]. ^[Karatina University, School of Business, P.O. Box 1957-10101, Karatina, Kenya]

\vspace{10mm}

**Key Words**: Microfinance, Efficiency, Social, Financial, Performance

\vspace{5mm}
**JEL Classification**: G210, G230

## Introduction

This work examines the drivers and levels of the financial and social efficiencies of microfinance institutions (MFIs) in Africa considering the transformation of MFIs from not-for-profit ventures to commercial entities. Specifically, the research examines the drivers of social efficiencies on the one hand, and critically, examines the drivers of the joint financial and social efficiency (socio-financial efficiency) of MFIs in Africa on the other hand. MFIs have a dual mission. First, they derive legitimacy by availing financial services to the poor and other often financially excluded members of society (Marconatto et al., 2016). To achieve this social goal, MFIs have in the past mostly relied on private donations and government subsidies (D’Espallier et al., 2017). However,  with the rise of neo-liberalism (Bateman, 2010), donors and stakeholders increasingly presume that MFIs should be financially self-sustaining, which is the second goal of MFIs (Beisland et al., 2017). Besides, political and economic uncertainties surrounding donations and subsidies reinforce the need for MFIs to be financially independent (Armendáriz et al., 2013, Garmaise and Natividad, 2013). 

If MFIs are to be financially sustainable, they should not do so by neglecting their social mission. The social mission of MFIs centers around providing approapriate and affordbale financial services to the financially excluded. In Africa, the financially excluded comprises mainly of women, youth and rural dwellers. When MFIs convert to the commercial model, they have to attain the financial objective of making profits over and above the social mission. The pursuit of financial and social objectives makes MFIs hybrid organisations. MFIs operate in peculiar commercial environments, yet their hybrid nature requires them to pursue and achieve an additional, core social objective. It is notable though that purely commercial firms are also under increasing pressure to also maximise on social welfare primarily through corporate social responsibility (CSR) interventions and the rise of the Environmental, Social and Governance (ESG) accounting  (Van Duuren et al., 2016). However, the expectation for business firms to exclusively meet social goals may not be as elevated as the expectations for social and hybrid enterprises, like MFIs, whose mission achievement is predicated on mainly from meeting their social mandate. 

In this study, we utilise Data Envelopment Analysis (DEA) to generate an index of efficiency scores for financial performance, social performance, and the joint socio-financial performance of MFIs in Africa. In examining efficiency, we focus on the extent to which MFIs optimise their output for a given level of inputs, using the output-oriented DEA approach. The alternative input-oriented approach deals with the ability of MFIs to minimise inputs for a given level of output. The choice of the output-oriented method derives from the functions of MFIs, that is, reaching out to the financially excluded sustainably. This means that although the optimisation of inputs is also desirable, it is the outputs that are more relevant to this study. The inputs are liabilities, equity and operating expense to assets ratio. The metric for the financial outcome is operational self-sufficiency (OSS). At the same time, the average loan balance per borrower, per cent of women borrowers and the percentage of the gross loan portfolio to total assets are the social performance indicators.

This research extends existing knowledge in three primary ways. First, the work sheds light on the determinants of the simultaneous drivers of the financial and social efficiencies of MFIs, especially in Africa, where data challenges had hitherto hindered relevant research. Secondly, as noted earlier, the paradigm shift towards the commercial approach means that MFIs should meet both financial and social objectives (D’Espallier et al., 2017, Chahine and Tannir, 2010). However, the extant research on the drivers of financial and social efficiencies tends to examine each objective separately instead of viewing them as two sides of the same coin (Efendic and Hadziahmetovic, 2017, Gutiérrez-Nieto et al., 2009). 

What is more noteworthy is that research on the social and financial efficiency of MFIs is principally in the context of the transformation from NGOs to commercial firms, and the post-conversion presence or absence of mission drift (Wassie et al., 2019, D’Espallier et al., 2017, Mersland and Strøm, 2010, Mia and Lee, 2017, Ramus and Vaccaro, 2017).  While some researchers find that better financial performance harms social outreach (Dacin et al., 2002, Kent and Dacin, 2013), others find the opposite to be true (Kar, 2013, Abeysekera et al., 2014). Researchers such as Leite et al. (2019) find mixed outcomes, with better financial performance harming depth of outreach while improving the breadth of outreach. Therefore, by simultaneously examining both financial and social efficiencies of MFIs, this study presents novel insights that extend the abundant literature on the financial and social performance of MFIs. 

The final contribution of our work is in respect of the drivers of social efficiency of MFIs. This contribution is paramount because it particularly informs decision making that would enhance outreach to the teeming population of the financially excluded. Researchers can, to an extent, infer the determinants of the financial performance of MFIs from insights of the plenty of extant research in corporate finance. That is not the case for social performance of MFIs and other financial institutions for that matter. Nason et al. (2018) note that unlike financial performance which has specific reference points, the criterion for evaluating social performance is ambiguous. Firms must then negotiate with stakeholders on suitable standards for assessing social performance. 

For this reason, some researchers gauge social performance by using the percentage of female borrowers, the proportion of rural borrowers, and the average loan size, all of which have their shortcomings. Much of the research in this domain dwells on the extent and causes of social failure, based on individual MFI social performance metrics without explicitly quantifying total social efficiency (Lebovics et al., 2016, Louis and Baesens, 2013, Louis et al., 2013) with the noted exception of  Gutiérrez-Nieto et al. (2009). The subsequent research output is difficult to compare.

Overall, little research investigates the socio-economic factors that enable or hinder the achievement of the dual objectives of MFIs. This absence of pertinent research is especially glaring in Africa, the continent with the lowest rates of financial inclusion. For the stakeholders of MFIs, this could be a significant oversight. Therefore, the management of MFIs may not know the optimal strategies to adapt in order to fulfil the twin missions. The donors may mistime their exit while regulators could set policies that hinder rather than enhance the efficacy of MFIs in fulfilling their dual mandate. Accordingly, this research will enlighten the management of MFIs, policymakers, donors, and stakeholders on interventions necessary to enable MFIs to reach the financially excluded sustainably. 

The setting of this study is Africa. We take all formal MFIs as the population, with the sampling frame being the MFIs that submit their data to the Microfinance Information Exchange (MIX) pooled database. MIX pools data from over 2000 MFIs across the globe that represents 20% of all formal MFIs across the world which in their assessment provide 80% of the microcredit and incidental financial services (The Microfinance Information Exchange, 2017). A significant issue in this regard is that a substantial number of financially excluded people often rely on informal financial services ranfnging from family and friends to neighbourhood kiosks and/or shylocks. There is also a rise of fintech firms that use mobile phones and the internet to offer inclusive financial services. However, the data for these equally essential portions of MFIs activities is hard to capture at scale. Hence, in this study, we will rely exclusively with the MFIs listed on the MIX database.

The remainder of the research proceeds as follows. In section 2, we review the empirical literature and layout the theoretical basis for the financial and social efficiency of MFIs. The following section provides a summary of the results of the study. Part 4 states the hypothesis and describes the empirical methods deployed in the research, while part 5 focuses on the data used in computing the efficiency scores and that serve as variables in the regression. Next, in section 6, we detail the results and the associated robustness checks and Section 7 concludes. 

## Theory and Empirical Literature

In Microfinance Schism, Morduch (2000) urges caution about the win-win view of microfinance. The win-win view posits that MFIs can simultaneously pursue and achieve both financial sustainability and social goals without trade-offs. This perspective seeks to reconcile the welfare approach that views financial sustainability and social performance to be incompatible, and the financial sustainability perspective which, while recognising the need for meeting social goals, emphasises financial sustainability. Morduch calls for the accommodation of multiple, hybrid MFI models as being on the continuum that includes those that seek profits while serving the poor and those that strictly focus on social goals like NGOs that are reliant on donations and subsidies. The broad array of microfinance programs, Morduch (2000) argued, would then serve diverse populations and contexts, instead of prioritizing or rating some MF models over others (Marconatto et al., 2016). 

Nonetheless, much of the ensuing research has compared the financial sustainability model with the welfare model, with empirical support on either side (Kodongo and Kendi, 2013). For instance, some research examines the extent to which different models of MFIs fare both financially and socially (Abeysekera et al., 2014, Bédécarrats et al., 2012). Socially, ample research finds NGO-oriented MFIs to be better at reaching out to the poor than commercial based MFI models, that is, more socially efficient. However, other researchers counter that commercial oriented MFIs are better at outreach to the poor without much reliance on donations and subsidies (Abeysekera et al., 2014, Kar, 2013, Roberts, 2013). For instance, Dorfleitner et al. (2017) and Bos and Millone (2015) find that MFIs that have better portfolio quality have a greater depth of outreach. This finding again highlights  the variety of metrics used to gauge the financial and social performance of MFIs.  

However, as Morduch(2000) further points out, MFI social performance could be dependent on the segments of the population served and regional and/or country-level contexts. Consequently, the definitions of poor and, by extension, social performance must expand to the different profiles and economic activities pertaining to poor people as MFIs may not be effectively reaching out to the "core" indigent. Also, the differing views on the levels social performance could result from the diverse meanings that different stakeholders, that is, employees, managers, MFI clients, and donors attach to the term social performance (Marti and Scherer, 2016). As the metrics for social performance are ambiguous (Nason et al., 2018), it is hard to reconcile the different views of the extent to which MFIs achieve their social objectives relative to financial goals. 

As a case in point, Beisland et al. (2020) examine the determinants of social performance using data from social rating agencies. The researchers conclude that different rating agencies place different weights on social indicators. Nevertheless, they find financial performance, rural outreach, service quality and customer service as critical determinants of MFI social performance. A related study by Hermes and Hudon (2018) identify firm-specific and economic factors that drive the social efficiency of MFIs by conducting a meta-analysis of published papers. Key among the factors identified are age, size, institutional type, and the funding sources of an MFI, thus collaborating earlier findings by Gutiérrez-Nieto et al. (2009). However, social ratings as a measure of social performance may not be feasible in the African context where data is a challenge. Again, the importance of each indicator could vary by context. The variance motivates the need for context-specific research. 

Much of the research that addresses both financial performance and social performance as stand-alones without addressing the conditions under which it is possible to achieve or fail to achieve these two respectively. Gutiérrez-Nieto et al. (2009) quantified financial and social performance using DEA efficiency estimation technique. Nonetheless, their study does not ascertain the drivers of financial efficiency, social efficiency, and/or combined socio-financial efficiency, as is the case in this study. Instead, these researchers examine the relationships between social performance on the one hand, and profitability, location, age, and legal type of MFI on the other. This study goes beyond that of Gutiérrez-Nieto et al. (2009) by examining the drivers of the joint socio-financial efficiency, and with a focus on Africa. Moreover, their data consisted of a narrower set of 89 MFIs and did not focus on a specific region for richer and potentially generalizable insights, as D'Espallier et al. (2017) propose. In addition to being dated, their study also uses a notably different set of inputs and outputs data for the DEA analysis. 

Heretofor, the dominant debate has been on the extent to which commercial MFIs can strike a balance between financial sustainability and social performance objectives, that is an attempt at mitigating the mission drift. Some researchers argue that the pursuit of financial sustainability is incompatible with outreach to the poor. (Cobb et al., 2016, Mia and Lee, 2017). The argument draws from the agency theory and its inherent profit incentive wherein the objectives of equity and debt holders would conflict with the strategic social goal of serving the poor. It is the agency theory that forms the bedrock of arguments from the welfare school in that MFIs cannot pursue financial sustainability while at the same time reaching out to the financially excluded. These views that MFIs are likely to shift their emphasis from outreach to the poor to generate returns for the investors due to pressure from equity holders and debt servicing requirements of creditors. [@] argue that restrictive covenants inherent in debt funding could push managers away from social targets to emphasising on making financial returns. Armendáriz et al. (2013) attribute mission drift to the need for MFIs to build up precautionary fund reserves as a cushion against uncertainties in subsidies and donations. 

However, other researchers like Im and Sun (2015), Lutzenkirchen et al. (2012), and Quayes (2012) argue that mission drift cannot happen to which Morduch and Ogden (2019) sensibly counter this point of view by arguing that NGO MFIs would either not exist or their number would be relatively small. It is notable that NGOs that rely on donations and subsidies still form a substantial number of MFIs (D’Espallier et al., 2013) which to some extent validates the concern about mission drift even among funders. Despite these reservations, some  works find that commercial MFIs can achieve both financial and social objectives (Kodongo and Kendi, 2013). Other researchers have found that the quest for financial sustainability lowers the chances of meeting social goals (Hishigsuren, 2006). 

Further, some scholars argue that mission drift is often confused with progressive lending and cross-subsidisation (Abeysekera et al., 2014). Notable among these studies is the mission expansion thesis by Mersland and Strøm (2010), which claims that financially sustainable MFIs can achieve better outreach through cross-subsidisation – lending at market rates to the relatively well-off and using the proceeds to subsidise interest payments for the poor. Interestingly, Campion and White (1999) and Ramus and Vaccaro (2017) argue that mission expansion could occur not as a result of the commercialisation of MFIs but due to a failure of corporate governance. Hence mission drift could be resolved at governance levels without affecting the financial positioning or social orientation of an MFI . 

Lastly, a closely related study by Lam et al. (2020) finds that MFIs exhibit no evidence of mission drift. Instead, they find that financial performance is positively associated with subsequent social performance in for-profit MFIs relative to not-for-profit MFIs. And in contrast, the social performance of not-for-profit MFIs varies positively with subsequent financial performance compared to for-profit MFIs. These authors thereore summise that for-profit MFIs are more efficient at translating financial performance to social goals while nonprofits are better at translating social objectives to financial goals. For nonprofits, part of the reason could be the goodwill generated by meeting social goals, which in turn lead to more support from donors, the state, and other stakeholders. MFIs that are profit-based, however, must first generate profit to enable them to address social goals. 

## Hypotheses
While the highlighted studies examine aspects of efficiency separately, this study goes further by looking into the collective, that is, joint,  financial and social performance. Hence, in addition to examining the drivers of financial and social efficiencies of MFIs, we hypothesise as follows.

- Hypothesis 1: MFIs that follow the commercial model exhibit better financial performance than MFIs that follow the NGO model. 
- Hypothesis 2: The social performance of NGO based MFIs is better than that of commercial model based MFIs.
- Hypothesis 3: The joint socio-financial performance of commercial MFIs differs from that of NGO model based MFIs. 

In these hypotheses, we note that most NGOs are also shifting to the commercial model but continue to rely substantially on donor funds, government subsidies and guarantees that allow access to low-cost commercial funds (D’Espallier et al., 2013). Further, the mission of NGO MFIs may defer markedly from that of commercial MFIs, meaning that even when pursuing profits, they are less likely to abandon the social goals (Louis et al., 2013). The section that follows summarises the results of the study.

## Summary of Results

This section highlights the levels and drivers of social efficiency, financial efficiency, and combined social and financial efficiency of MFIs in Africa. The inputs for the DEA analysis constitute measures for financial performance and social performance. We capture financial performance using the operational self-sufficiency (OSS). For social performance, we use three metrics. To measure the depth of outreach, we use the per cent of women borrowers and average loan balance per borrower. These metrics capture the ability of MFIs to reach the most financially excluded people like women and other people that typically demand small loans sizes. The gross loan portfolio to assets measures the breadth of outreach – the sheer number of people the MFI can reach. The discussion captures both the individual inputs and the overall DEA score. 

### Social Efficiency

MFIs exhibit a high level of social efficiency, consistent with their mission of providing financial services to the financially excluded, mostly the poor. On a scale of zero to one, the mean and median DEA social efficiency score is 0.92, with substantial variation across legal forms of MFIs. NGOs top with a median social efficiency score of 0.96, followed by NBFIs, commercial banks, rural banks, and cooperatives with median scores of 0.92, 0.91, 0.90, and 0.89, respectively. These results show that legal status, and by extension, the profit orientation matters in the social performance of MFIs. However, capital structure- the debt-equity mix and donations are not significant drivers of social efficiency. The ratio of operating expense to assets relates negatively to social efficiency. Given that operating expense is a significant factor in profitability, it points to a potential conflict between financial performance and social performance. Capital asset ratio relates positively with social performance while asset structure exhibits a negative relationship. Lastly, education relates positively with social efficiency of MFIs a result that could hold given that awareness could allow poor and financially excluded people to regularly engage with the providers of financial services. 

### Financial efficiency

MFIs in Africa are barely financially sustainable, with marginal disparities between the legal types. On a scale of zero to one, the mean and median financial efficiency scores are 0.42 and 0.41, respectively. Rural banks have the highest median financial efficiency score (0.419), followed by cooperatives (0.415) and NGOs (0.408), while commercial banks (0.406) and Non- Bank Financial Institutions (NBFIs) (0.402) trail. Again, the capital structure is not a significant driver of financial efficiency. Instead, the drivers of financial efficiency are operating expense to assets ratio, capital to assets ratio, asset structure and education. Operating expenses, asset structure and education all vary negatively with financial performance. Operating expenses dominate the expense item on the income statement, while higher asset structure means the MFI dedicates a substantial amount cash to finance non-current assets which takes time to recoup. Capital asset ratio varies positively with financial performance, social performance, and joint financial and social performance. Education would proxy the customer base, with the more exposed the populace, the less they get financial services from MFIs, preferring the mainstream financial system instead. These results are in line with some line of research on the financial sustainability of MFIs across the globe (Bayai and Ikhide, 2016). 

### Social and Financial Efficiency
The joint financial and social efficiency scores follow those of social efficiency. The mean and median efficiency score is 0.92 but varies with the legal type of MFI. NGOs lead with a median efficiency score of 0.959, followed by NBFIs (0.915), Commercial Banks (0.908), Rural Banks (0.897), and Cooperatives/ Credit Unions (0.890). As with social efficiency, capital structure- the debt-equity mix and donations are not significant drivers of social efficiency. The ratio of operating expense to assets relates negatively to social efficiency. Lastly, education relates positively with social efficiency of MFIs. 

## Method
The study adopts a quantitative approach with the model specified next.

### The Empirical Model

We primarily use the random-effects model as per the results of the Hausman Test (see Appendix 2 and 3). For robustness, however, we also run fixed effects, the pooled OLS, the between estimator, the first difference. We estimate the following model.

 							                       <1>
 							                       
 							                       
 represents the dependent variable which takes the form of efficiency scores from the data envelopment analysis (DEA) model. In computing DEA, we follow the intermediation approach, where the inputs are net fixed assets, operating expenses to assets ratio, deposits to total assets ratio, liabilities and equity, and donations. The outputs comprise of the per cent of female borrowers, average loan balance per borrower, gross loans to total assets ratio, and the operational self-sufficiency (OSS). These input and output variables are described in more detail in section 5.1, together with the mechanics of the DEA model in part 5.  on the other hand, represents the set of independent variables as follows described in Table 1 below. 
5.2	Data, Data Sources and Description of Variables 
We source our data from the Microfinance Information Exchange (MIX) pooled database. The dataset used in this article consists of 705 MFIs across Africa. While the MIX data is not a comprehensive representation of the microfinance industry in Africa, it does provide general trends in the sector (Jarotschkin, 2013).

